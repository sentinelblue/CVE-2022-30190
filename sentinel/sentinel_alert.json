{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentz`.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workspaceName": {
        "type": "string",
        "metadata": {
          "description": "Workspace name for Log Analytics where Sentinel is setup."
        }
      },
      "analyticsRuleDisplayName": {
        "type": "string",
        "defaultValue": "CVE-2022-30190 Detect Office Applications Spawning msdt",
        "metadata": {
          "description": "The display name of the Azure Sentinel custom analytics rule."
        }
      },
      "analyticsRuleDescription": {
        "type": "string",
        "defaultValue": "This query detects possible abuse of ms-msdt MSProtocol URI scheme to load and execute malicious code via Microsoft Support Diagnostic Tool Vulnerability (CVE-2022-30190).",
        "metadata": {
          "description": "The description of the Azure Sentinel custom analytics rule."
        }
      },
      "analyticsRuleSeverity": {
        "type": "string",
        "defaultValue": "High",
        "allowedValues": [
          "Informational",
          "Low",
          "Medium",
          "High"
        ],
        "metadata": {
          "description": "The severity of the Azure Sentinel custom analytics rule."
        }
      }
    },
    "resources": [
      {
        "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspaceName'), 'Microsoft.SecurityInsights'),'/alertRules/aaf2f367-384b-49cf-a02a-aa39e92218f4')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/aaf2f367-384b-49cf-a02a-aa39e92218f4')]",
        "kind": "Scheduled",
        "apiVersion": "2021-09-01-preview",
        "properties": {
          "displayName": "[parameters('analyticsRuleDisplayName')]",
          "description": "[parameters('analyticsRuleDescription')]",
          "severity": "[parameters('analyticsRuleSeverity')]",
          "enabled": true,
          "query": "imProcess\n| where ActingProcessName has_any (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")\n| where TargetProcessName contains 'msdt.exe'\n| project-reorder \n    TimeGenerated,\n    DvcHostname,\n    TargetProcessName,\n    TargetProcessId,\n    TargetProcessCommandLine,\n    ActingProcessName,\n    ActingProcessId,\n    ActingProcessCommandLine,\n    *\n",
          "queryFrequency": "PT5M",
          "queryPeriod": "PT5M",
          "triggerOperator": "GreaterThan",
          "triggerThreshold": 0,
          "suppressionDuration": "PT5M",
          "suppressionEnabled": false,
          "tactics": [
            "Execution",
            "Persistence",
            "DefenseEvasion"
          ],
          "alertRuleTemplateName": null,
          "incidentConfiguration": {
            "createIncident": true,
            "groupingConfiguration": {
              "enabled": true,
              "reopenClosedIncident": false,
              "lookbackDuration": "PT5M",
              "matchingMethod": "AllEntities",
              "groupByEntities": [],
              "groupByAlertDetails": [],
              "groupByCustomDetails": []
            }
          },
          "eventGroupingSettings": {
            "aggregationKind": "SingleAlert"
          },
          "entityMappings": [
            {
              "entityType": "Host",
              "fieldMappings": [
                {
                  "identifier": "FullName",
                  "columnName": "DvcHostname"
                }
              ]
            },
            {
              "entityType": "Process",
              "fieldMappings": [
                {
                  "identifier": "CommandLine",
                  "columnName": "TargetProcessCommandLine"
                },
                {
                  "identifier": "ProcessId",
                  "columnName": "TargetProcessId"
                }
              ]
            },
            {
              "entityType": "Process",
              "fieldMappings": [
                {
                  "identifier": "CommandLine",
                  "columnName": "ActingProcessCommandLine"
                },
                {
                  "identifier": "ProcessId",
                  "columnName": "ActingProcessId"
                }
              ]
            },
            {
              "entityType": "File",
              "fieldMappings": [
                {
                  "identifier": "Name",
                  "columnName": "TargetProcessName"
                }
              ]
            },
            {
              "entityType": "File",
              "fieldMappings": [
                {
                  "identifier": "Name",
                  "columnName": "ActingProcessName"
                }
              ]
            }
          ]
        }
      }
    ]
  }