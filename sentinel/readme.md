# Microsoft Sentinel

## Overview

We can utilize Microsoft Sentinel to perform hunting, or past analysis, on the indicators that closely resemble  this vulnerability. Then we can use the same queries to generate alerts on any activity matching the indicators seen.

Note: You will need to utilize the ASIM "process event" schema and parsing function for these queries. As well, we are utilizing Sysmon in our environment to supply the ASIM process parser.

⚠️⚠️⚠️⚠️

To utilize the below alert you need to have ASIM parsers (specifically the "Process Event" schema/parsers) installed to your Sentinel workspace. Deploy them via <https://github.com/Azure/Azure-Sentinel/tree/master/ASIM>

⚠️⚠️⚠️⚠️


## Deploy to Azure Buttons

### Analytics Rule

This is also an ASIM query.

Deploy an analytic rule to your workspace by using the buttons below.

[Review the analytics rule template here](/sentinel/sentinel_alert.yaml)

Then deploy the Sentinel Analytics rule to your Sentinel workspace below.

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fsentinelblue%2fCVE-2022-30190%2fmain%2fsentinel%2fsentinel_alert.json)

[![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://portal.azure.us/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fsentinelblue%2fCVE-2022-30190%2fmain%2fsentinel%2fsentinel_alert.json)

## Logs

Utilizing Sysmon we can observe quite a bit of activity. Process creation, image loaded, and network activity are all populated events by our Sysmon configuration. Included in this directory is an example of the raw process creation event in XML. We can utilize to generate an our alert. See [sysmon process create alert](/sentinel/process_create.xml) for the XML raw log.

The windows diagnostic utility will also generate a log of it's own. This can be found in the user's app data directory ```C:\Users\testuser\AppData\Local\Temp\Diagnostics\WINWORD```. The diagnostic file can be analyzed should anything be found in your environment. For example, included in the log is the source IP address the malicious code downloaded. In my POC example this was a "192.168.2.158:8000" address.

```text
05/31/2022 15:09:55.435	WINWORD (0x8960)	0x96A0	Microsoft Word	Identity Http Client	c081b	Medium	LastMileHttpTimings {"Message":"-1/-1/-1/2/2/2/4/4/4/5/5/","RequestId":"2","Result":0,"Status":501,"ServerRequestId":"","MSEdgeRefA":"","ServerPathPrefix":"http://192.168.2.158:8000","IsAsync":false,"Version":1}	
```

## Hunting

Note: This is an ASIM query.

Refer to more queries in "[hunting.kql](/sentinel/example_hunting.kql)". Below is the same query we are using for an alert over 365 days instead analytic rule setting of 5 minutes for this alert.

```kql
// search for our alert across a longer period of time
imProcess
| where TimeGenerated > ago(365d)
| where ActingProcessName has_any ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")
| where TargetProcessName contains 'msdt.exe'
| project-reorder 
    TimeGenerated,
    DvcHostname,
    TargetProcessName,
    TargetProcessId,
    TargetProcessCommandLine,
    ActingProcessName,
    ActingProcessId,
    ActingProcessCommandLine,
    *
```

## Updates

#### V1.0.0

Initial upload of content.
